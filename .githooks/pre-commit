#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(git rev-parse --show-toplevel)"
cd "$ROOT_DIR"

STAGED_FILES="$(git diff --cached --name-only --diff-filter=ACMR)"

if [ -z "$STAGED_FILES" ]; then
  exit 0
fi

yaml_files=()
md_files=()
workflow_files=()

while IFS= read -r file; do
  [ -z "$file" ] && continue
  case "$file" in
    *.yml|*.yaml)
      yaml_files+=("$file")
      ;;
  esac
  case "$file" in
    *.md)
      md_files+=("$file")
      ;;
  esac
  case "$file" in
    .github/workflows/*.yml|.github/workflows/*.yaml)
      workflow_files+=("$file")
      ;;
  esac
done <<< "$STAGED_FILES"

if [ "${#yaml_files[@]}" -gt 0 ]; then
  if ! command -v yamllint >/dev/null 2>&1; then
    echo "yamllint not found. Install it first (e.g. pip install yamllint)." >&2
    exit 1
  fi
  echo "Running yamllint..."
  yamllint -c .yamllint.yaml "${yaml_files[@]}"
fi

if [ "${#md_files[@]}" -gt 0 ]; then
  echo "Running markdownlint..."
  npx --yes markdownlint-cli --config .markdownlint.yaml "${md_files[@]}"
fi

if [ "${#workflow_files[@]}" -gt 0 ]; then
  if ! command -v actionlint >/dev/null 2>&1; then
    echo "actionlint not found. Install it with:" >&2
    echo "  go install github.com/rhysd/actionlint/cmd/actionlint@latest" >&2
    exit 1
  fi
  echo "Running actionlint..."
  actionlint "${workflow_files[@]}"
fi

echo "Pre-commit checks passed."
